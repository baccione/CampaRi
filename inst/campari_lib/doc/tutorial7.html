<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
############################################################################
# LICENSE INFO:                                                            #
############################################################################
#    This file is part of CAMPARI.                                         #
#                                                                          #
#    Version 2.0                                                           #
#                                                                          #
#    Copyright (C) 2014, The CAMPARI development team (current and former  #
#                        contributors)                                     #
#                        Andreas Vitalis, Adam Steffen, Rohit Pappu, Hoang #
#                        Tran, Albert Mao, Xiaoling Wang, Jose Pulido,     #
#                        Nicholas Lyle, Nicolas Bloechliger                #
#                                                                          #
#    Website: http://sourceforge.net/projects/campari/                     #
#                                                                          #
#    CAMPARI is free software: you can redistribute it and/or modify       #
#    it under the terms of the GNU General Public License as published by  #
#    the Free Software Foundation, either version 3 of the License, or     #
#    (at your option) any later version.                                   #
#                                                                          #
#    CAMPARI is distributed in the hope that it will be useful,            #
#    but WITHOUT ANY WARRANTY; without even the implied warranty of        #
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         #
#    GNU General Public License for more details.                          #
#                                                                          #
#    You should have received a copy of the GNU General Public License     #
#    along with CAMPARI.  If not, see <http://www.gnu.org/licenses/>.      #
############################################################################
# AUTHORSHIP INFO:                                                         #
############################################################################
#                                                                          #
# MAIN AUTHOR:   Andreas Vitalis                                           #
# CONTRIBUTIONS: Adam Steffen                                              #
#                                                                          #
############################################################################
-->
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US" xml:lang="en">
<head>
    <!--
    Designed by CAMPARI Development Group
    Base template (without user's data) checked by http://validator.w3.org : "This page is valid XHTML 1.0 Transitional"
    -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"></meta>
    <title>CAMPARI Tutorial 7</title>
    <link rel="stylesheet" href="style_red.css" type="text/css" media="screen"></link>
</head>
<body>
<div id="art-page-background-simple-gradient"></div>
<div id="art-main">
    <!-- Header -->
    <div class="art-Sheet2">
        
        <!-- Banner Art -->
        <div class="art-Header">
            <div class="art-Header-png"></div>
        </div>
                
        <!-- Top Navigation Bar -->
        <div class="art-nav">
            <div class="l"></div>
            <div class="r"></div>
            <ul class="art-menu">
                <li><a href="index.html"><span class="l"></span><span class="r"></span><span class="t">Home</span></a></li>
                <li><a href="documentation.html" class=" active"><span class="l"></span><span class="r"></span><span class="t">Documentation</span></a></li>
                <li><a href="references.html"><span class="l"></span><span class="r"></span><span class="t">References</span></a></li>
                <li><a href="contact.html"><span class="l"></span><span class="r"></span><span class="t">Support</span></a></li>
                <li><a href="download.html"><span class="l"></span><span class="r"></span><span class="t">Download</span></a></li>
            </ul>
        </div>
            
        <!-- Top Sub Navigation Bar -->
        <div class="nav-menu">
            <ul class="navlist">
                <li><a href="documentation.html">Overview</a></li>
                <li><a href="install.html">Install</a></li>
                <li><a href="tutorials.html" class=" active">Tutorials</a></li>
                <li><a href="inputfiles.html">Inputfiles</a></li>
                <li><a href="keywords.html">Keywords</a></li>
                <li><a href="outputfiles.html">Outputfiles</a></li>
                <li><a href="parameters.html">Parameters</a></li>
                <li><a href="development.html">Development</a></li>
                <li></li>
            </ul>
        </div> 
    </div>
        
    <!-- Main Page Contents -->
    <div class="art-Sheet">
        <div class="art-Sheet-bl"></div>
        <div class="art-Sheet-br"></div>
        <div class="art-Sheet-bc"></div>
        <div class="art-Sheet-cl"></div>
        <div class="art-Sheet-cr"></div>
        <div class="art-Sheet-cc"></div>
        <div class="art-Sheet-body">
            
            <div class="art-contentLayout">
                <!-- Page Contents -->
                <div class="art-content">
                <div class="art-Post">
                <div class="art-Post-body">
<div class="art-PostContent">
<br/>
<h2>Tutorial 7: Advanced Simulation Methodology - Calculating the Free Energy of Solvation of Methanol in Water</h2>
<h3>Preface:</h3>
In this tutorial, we show how CAMPARI can be used to calculate the free energy of solvation of a net-neutral
small molecule in aqueous solution (FES), specifically, the transfer free energy associated with the transfer from
gas phase into dilute solution. Free energies are not typically observables that can be obtained from an individual
simulation in a single state or phase. For the transfer from the gas phase to aqueous solution, we could theoretically
attempt to measure the partition coefficient in a two phase simulation (akin to a vapor pressure measurement). This
is extremely impractical, however. Instead, the FES can be estimated by a computational trick: we scale the 
interactions between solute (small molecule) and solvent (water) between zero (as if the molecule were absent &rarr; 
gas-phase reference) and their normal strength (as if the molecule were fully present &rarr; dilute solution reference).
In constant volume, constant temperature conditions, the two end states are connected via:<br/>
<br/>
A(I&rarr;F) = A<sub>F</sub> - A<sub>I</sub> = -k<sub>b</sub>T&#183;ln(&lt;e<sup>&beta;&#183;(U<sub>F</sub>-U<sub>I</sub>)</sup>&gt;<sub>I</sub>)<br/>
<br/>
Here, &beta;<sup>-1</sup>=k<sub>b</sub>T, A denotes the Helmholtz free energy, and U the internal energy. This free energy
perturbation (FEP) formula forms the basis for the more complex Bennett Acceptance Ratio method (BAR). It is generally 
taken advantage of microscopically by running a simulation at a single condition (for example I), but evaluating energies
at both conditions F and I to accumulate the thermodynamic average in above equation. The convergence of this formula
is very poor if the ensembles corresponding to the two conditions are very different. Therefore, the two end states
of the solvation process are interpolated by a series of numerically appropriate, unphysical states. With free
energy being a state function, the total free energy for the process can then be recovered as the sum of stepwise perturbations
between sufficiently similar states:<br/>
<br/>
A(I&rarr;F) = A<sub>F</sub> - A<sub>I</sub> = -k<sub>b</sub>T&#183;&Sigma;<sub>i=1,N-1</sub>ln(&lt;e<sup>&beta;&#183;(U<sub>i+1</sub>-U<sub>i</sub>)</sup>&gt;<sub>i</sub>)<br/>
<br/>
By flipping states I and F, we can define a formally equivalent process that in practice often behaves somewhat differently
(in terms of systematic errors and convergence properties). The reason lies in the directionality of the process (one is either
"growing in" or "fading out" the solute molecule) coupled to the properties of the exponential average. The BAR method can be
thought of as a self-consistent way to treat both directions at the same time, and is generally more accurate.<br/>
In summary, our tutorial will consist of a parallel, but non-exchanging simulation set up to determine the FES of methanol
in water by scaling interactions according to a sufficiently fine schedule. It will cover the previously untouched field
of free energy growth methods within CAMPARI, and explain a few more details regarding multi-Hamiltonian simulations in
parallel execution. Many details and algorithms will be touched upon briefly, and the reader is referred to the literature
for appropriate background knowledge. This tutorial does aim to provide answers for why certain choices are necessary and others
would be unacceptable.<br/>
<br/>
<h3>Step-by-step:</h3>
<big style="font-style: italic; text-decoration: underline;">Step 1 -
Set up system (topologically) and parameters</big><br/>
<br/>
Free energies of solvation will naturally depend upon the force field chosen to represent solute-solute, solute-solvent, and solvent-solvent
interactions. Here, we settle on the <a href="references.html#ref1_7">OPLS-AA/L force field</a> in conjunction with the TIP3P water model:<br/>
<br/><tt><a href="keywords.html#PARAMETERS">PARAMETERS</a> &lt;full path to CAMPARI directory&gt;/params/oplsaal.prm</tt><br/><br/>
Take the reference settings for the Hamiltonian straight from the <a href="keywords.html#OPLSAAL">documentation</a>:<br/>
<br/>
<tt>
<a href="keywords.html#UAMODEL">FMCSC_UAMODEL</a> 0<br/>
<a href="keywords.html#INTERMODEL">FMCSC_INTERMODEL</a> 2<br/>
<a href="keywords.html#ELECMODEL">FMCSC_ELECMODEL</a> 1<br/>
<a href="keywords.html#MODE_14">FMCSC_MODE_14</a> 2<br/>
<a href="keywords.html#FUDGE_EL_14">FMCSC_FUDGE_EL_14</a> 0.5<br/>
<a href="keywords.html#FUDGE_ST_14">FMCSC_FUDGE_ST_14</a> 0.5<br/>
<a href="keywords.html#SC_IPP">FMCSC_SC_IPP</a> 1.0<br/>
<a href="keywords.html#SC_ATTLJ">FMCSC_SC_ATTLJ</a> 1.0<br/>
<a href="keywords.html#EPSRULE">FMCSC_EPSRULE</a> 2<br/>
<a href="keywords.html#SIGRULE">FMCSC_SIGRULE</a> 2<br/>
<a href="keywords.html#SC_POLAR">FMCSC_SC_POLAR</a> 1.0<br/>
<a href="keywords.html#SC_BONDED_B">FMCSC_SC_BONDED_B</a> 1.0<br/>
<a href="keywords.html#SC_BONDED_A">FMCSC_SC_BONDED_A</a> 1.0<br/>
<a href="keywords.html#SC_BONDED_T">FMCSC_SC_BONDED_T</a> 1.0<br/>
<a href="keywords.html#SC_BONDED_I">FMCSC_SC_BONDED_I</a> 1.0<br/>
<a href="keywords.html#SC_EXTRA">FMCSC_SC_EXTRA</a> 0.0<br/>
<a href="keywords.html#IMPROPER_CONV">FMCSC_IMPROPER_CONV</a> 2<br/>
<a href="keywords.html#TEMP">FMCSC_TEMP</a> 298.0<br/>

</tt>
<br/>
This is enough to ensure that we describe the interactions within the system according to the OPLS standard. In addition, we set
the temperature to 298.0K. Next, we need to think
about the system geometrically. In a condensed phase, boundary artifacts are most easily minimized by using periodic boundaries.
Another concern are finite-size effects: i) we will want to use an appropriate cutoff scheme, which imposes certain minimal
size requirements on our system, ii) numbers are more reliable and long-range corrections (see below for all of these) less relevant
if the physical water bath is large enough, iii) our simulation will be performed in the canonical (NVT) ensemble and setting the 
right density requires some estimate of solute volume (which is different along the interpolation schedule) which would cause problems
if the water bath does not possess a sufficiently large volume. Here, we choose a 32.0x32.0x32.0&#8491; periodic, cubic box filled by
a single methanol and 1084 water molecules:<br/>
<br/>
<tt>
<a href="keywords.html#BOUNDARY">FMCSC_BOUNDARY</a> 1<br/>
<a href="keywords.html#SHAPE">FMCSC_SHAPE</a> 1<br/>
<a href="keywords.html#SIZE">FMCSC_SIZE</a> 32.0 32.0 32.0<br/>
<a href="inputfiles.html#FMCSC_SEQFILE">FMCSC_SEQFILE</a> &lt;full path to CAMPARI directory&gt;/examples/tutorial7/<a href="../examples/tutorial7/tutorial7.seq">tutorial7.seq</a><br/>
</tt>
<br/>
Feel free to experiment later on with these settings.<br/>
<br/><big style="font-style: italic; text-decoration: underline;">Step 2 -
Set up interpolation conditions (in parallel):</big><br/>
<br/>
So far, our key-file allows for the simulation of methanol in water with the solute fully interacting with solvent only. How do
we enable simulations at different interpolated conditions?<br/>
<br/>
<tt>
<a href="keywords.html#GHOST">FMCSC_GHOST</a> 1<br/>
<a href="keywords.html#FEG_MODE">FMCSC_FEG_MODE</a> 2<br/>
<a href="inputfiles.html#FMCSC_FEGFILE">FMCSC_FEGFILE</a> &lt;full path to CAMPARI directory&gt;/examples/tutorial7/<a href="../examples/tutorial7/tutorial7.ghost">tutorial7.ghost</a><br/>
</tt>
<br/>
These three keywords enable scaling of specific interactions between designated residues or molecules (file input).
<a href="keywords.html#FEG_MODE">FMCSC_FEG_MODE</a> controls what happens to non-bonded interactions between atoms that are both part
of the designated molecule(s). For methanol, this is an issue we cannot entirely ignore since the polar hydrogen does 
interact with the aliphatic hydrogens, as they are separated by three bonds. We choose the mode corresponding to having
those interactions be scaled as well. You will find in the literature that typically solute-solute interactions are <i>not</i>
scaled which simplifies the corrections we have to apply. However, in such a case the framework for applying long-range electrostatic
algorithms is not entirely consistent (for most users, it will be appropriate to ignore this detail).<br/>
For a simulation at a single condition, the following keywords control the details of solute-solvent interactions:<br/>
<br/>
<tt>
<a href="keywords.html#FEG_IPP">FMCSC_FEG_IPP</a> 1.0<br/>
<a href="keywords.html#FEG_ATTLJ">FMCSC_FEG_ATTLJ</a> 0.55<br/>
<a href="keywords.html#FEG_POLAR">FMCSC_FEG_POLAR</a> 0.61<br/>
<a href="keywords.html#FEG_BONDED_B">FMCSC_FEG_BONDED_B</a> 1.0<br/>
<a href="keywords.html#FEG_BONDED_A">FMCSC_FEG_BONDED_A</a> 1.0<br/>
<a href="keywords.html#FEG_BONDED_T">FMCSC_FEG_BONDED_T</a> 1.0<br/>
<a href="keywords.html#FEG_BONDED_I">FMCSC_FEG_BONDED_I</a> 1.0<br/>
<a href="keywords.html#FEG_CBMODE">FMCSC_CBMODE</a> 1<br/>
<a href="keywords.html#FEG_LJMODE">FMCSC_LJMODE</a> 2<br/>
</tt>
<br/>
The first three keywords are what varies across different replicas in the parallel simulation in the end, and the values provided
here are for illustration only (in all cases: setting to 0.0 will completely disable that component of the solute-solvent interactions,
while unity corresponds to the fully interacting limit). The next four keywords are simply required to match the OPLS reference
interaction model with respect to bonded interactions. The two remaining keywords determine how exactly interactions are scaled.
For electrostatic interactions, linear scaling is appropriate, but for steric and dispersive terms a modified functional
form is selected (a so-called "soft-core" potential). This entails additional parameters which we we will leave at default values
(<a href="keywords.html#FEG_LJRAD">FMCSC_LJRAD</a>, <a href="keywords.html#FEG_LJEXP">FMCSC_LJEXP</a>, and 
<a href="keywords.html#FEG_LJSCEXP">FMCSC_LJSCEXP</a>).<br/>
Previous tutorials showed how parallel runs are set up in which temperature varies across replicas. Here, we now require that
parameters of the Hamiltonian controlling solute-solvent interactions vary across replicas.<br/>
<br/>
<tt>
<a href="inputfiles.html#FMCSC_REFILE">FMCSC_REFILE</a> &lt;full path to CAMPARI directory&gt;/examples/tutorial7/<a href="../examples/tutorial7/tutorial7.rex">tutorial7.rex</a><br/>
<a href="keywords.html#REPLICAS">FMCSC_REPLICAS</a> 24<br/>
<a href="keywords.html#REDIM">FMCSC_REDIM</a> 3<br/>
<a href="keywords.html#REMC">FMCSC_REMC</a> 1<br/>
<a href="keywords.html#REFREQ">FMCSC_REFREQ</a> 20000000000<br/>
</tt>
<br/>
If you examine the replica input file, you will note a fairly specific schedule which interpolates between all three non-bonded
interaction keywords being zero to all being unity. Cavity formation is usually the most critical step in "growing in" a solute
so most the schedule is spent building up the value for <a href="keywords.html#FEG_IPP">FMCSC_FEG_IPP</a>. Note how polar
interactions are only allowed to be present if the solute is sterically fully present (causes numerical instabilities otherwise).
There are not many rules for creating good schedules, but any calculation should use suitable metrics (described in the literature)
to identify weak portions of the schedule and refine it accordingly (since systematic errors are incredibly difficult to
diagnose in FES calculations). Here, we use a 24-point schedule and consequently have 24 replicas. We do not actually wish
to use the replica-exchange functionality here, and therefore disable swaps by setting their interval parameter to something
longer than the simulation itself.<br/>
<br/><big style="font-style: italic; text-decoration: underline;">Step 3 -
Think about implementation / execution details that guarantee sufficient computational efficiency:</big><br/>
<br/>
In order to actually perform any type of simulation, we have to deal withe the set of technicalities pertaining to cutoffs.
Cutoffs are indispensable to almost any simulation by limiting the physical range of interactions in some (usually artificial)
framework. Only then can large systems be simulated for any reasonable amount of steps or time. For the production runs, we
will use plain cutoffs for steric and dispersive interactions, and the reaction-field method for electrostatic interactions.
Given that the solute is neutral, this is appropriate:<br/>
<br/>
<tt>
<a href="keywords.html#CUTOFFMODE">FMCSC_CUTOFFMODE</a> 3<br/>
<a href="keywords.html#NBCUTOFF">FMCSC_NBCUTOFF</a> 12.0<br/>
<a href="keywords.html#ELCUTOFF">FMCSC_ELCUTOFF</a> 12.0<br/>
<a href="keywords.html#LREL_MD">FMCSC_LREL_MD</a> 3<br/>
<a href="keywords.html#NBL_UP">FMCSC_NBL_UP</a> 5<br/>
<a href="keywords.html#GRIDDIM">FMCSC_GRIDDIM</a> 8 8 8<br/>
<a href="keywords.html#GRIDMAXGPNB">FMCSC_GRIDMAXGPNB</a> 512<br/>
</tt>
<br/>
For dynamics calculations, this corresponds to grid-based cutoffs with an update frequency for neighbor list every five steps,
a single cutoff for all interactions at 12.0&#8491; with reaction-field corrections applied to taper the electrostatic
contributions to exactly zero at 12.0&#8491;. Most settings here deal not with physical principles but with computational efficiency.
However, for this type of application, some of them will have additional relevance. For instance, we choose the reaction-field
method because it is compatible with free energy calculations of the type attempted here.<br/>
<br/><big style="font-style: italic; text-decoration: underline;">Step 4 -
Create different random, somewhat equilibrated starting conformations for all conditions (in parallel):</big><br/>
<br/>
Ultimately, for the condensed phase, we wish to use a dynamics method to sample the system. To create randomized structures, however,
dynamics is inappropriate since it requires somewhat equilibrated structures to start with (the integrator will otherwise become
unstable and the system will "explode"). Furthermore, we will want to restart the actual production simulation later on with
each different replica using a different starting conformation. To achieve all this, we use a bit of trickery that CAMPARI
offers:<br/>
<br/>
<tt>
<a href="keywords.html#NRSTEPS">FMCSC_NRSTEPS</a> 210000<br/>
<a href="keywords.html#EQUIL">FMCSC_EQUIL</a> 500000<br/>
<a href="keywords.html#ENSEMBLE">FMCSC_ENSEMBLE</a> 1<br/>
<a href="keywords.html#DYNAMICS">FMCSC_DYNAMICS</a> 5<br/>
<a href="keywords.html#FRICTION">FMCSC_TSTAT_TAU</a> 0.1<br/>
<a href="keywords.html#TIMESTEP">FMCSC_TIMESTEP</a> 0.001<br/>
<a href="keywords.html#CYCLE_MC_FIRST">FMCSC_CYCLE_MC_FIRST</a> 200000<br/>
<a href="keywords.html#CYCLE_DYN_MIN">FMCSC_CYCLE_DYN_MIN</a> 140000<br/>
<a href="keywords.html#CYCLE_DYN_MAX">FMCSC_CYCLE_DYN_MAX</a> 140000<br/>
<a href="keywords.html#RSTOUT">FMCSC_RSTOUT</a> 210000<br/>
<a href="keywords.html#RANDOMIZE">FMCSC_RANDOMIZE</a> 1<br/>
<a href="keywords.html#RIGIDFREQ">FMCSC_RIGIDFREQ</a> 0.995<br/>
</tt>
<br/>
This set of keywords yields a hybrid Monte Carlo (MC) / molecular dynamics (MD) run in the canonical ensemble that starts with 2x10<sup>5</sup>
MC steps from a truly random system followed by 10<sup>4</sup> MD steps. A restart file is written for all replicas at the end of the run.
We define a small <a href="keywords.html#TIMESTEP">integration time step</a> (1fs, to avoid integrator crashes in case the
MC part leaves some sterically unfavorable contacts) and a small <a href="keywords.html#TSTAT_TAU">coupling time</a> for the (default)
<a href="keywords.html#TSTAT">thermostat</a>. 
Note that the dynamics happen in <a href="keywords.html#CARTINT">rigid-body/torsional space</a> as in <a href="tutorial5.html">Tutorial 5</a>.
Since the system is quite similar, we also use the same stability improvements here from the beginning:<br/>
<br/>
<tt>
<a href="keywords.html#TMD_INTEGRATOR">FMCSC_TMD_INTEGRATOR</a> 1<br/>
<a href="keywords.html#TMD_INT2UP">FMCSC_TMD_INT2UP</a> 4<br/>
</tt>
<br/>
Note that during production runs it will be important that our integrator produces appropriate fluctuations for the potential energy in order
for the analysis to be accurate (this is the reason why the use of the <a href="keywords.html#TSTAT">Berendsen thermostat</a>
would give rise to systematic errors here).
You should now be prepared to run this simulation by pasting
all keywords mentioned thus far in an appropriate file (say "fes.key") and doing:<br/>
<br/>
<tt>
mpirun -np 24 campari_mpi -k fes.key<br/>
</tt>
<br/>
This naturally assumes that you have obtained a working MPI version (see <a href="install.html">installation instructions</a>).
If your work station does not have 24 cores, it may be necessary to guide MPI to the computers you plan on using (for instance
in a cluster/supercomputing setting). The details of the command may also change if you use specific MPI settings or a different
MPI implementation altogether. While it is theoretically possible to maintain more MPI threads than there are cores in the
computer, this can easily crash the machine due to overload (and should be avoided). If you want to use this tutorial on 
a single computer (with multiple cores), simply adjust the value for <a href="keywords.html#REPLICAS">FMCSC_REPLICAS</a> 
to something reasonable - the only difference will be that in the end, the free energy change with some unphysical process
is calculated and not the proper FES (since only the first so many entries in the replica input file are used). If CAMPARI
complains about this (see N_000.log and so on ...), you may also have to adjust the value for
<a href="keywords.html#REDIM">FMCSC_REDIM</a> Technically, the tutorial does not depend on the number of replicas.<br/>
In rare cases, CAMPARI may fail due to integrator instability. In this case, simply rerun the calculation (this behavior
is due to the stochastic nature of the MC portion). The run should finish within an hour or so, but this may vary considerably
depending on compilation options, hardware, <i>etc.</i> If successful, the latest structure for each condition is most accurately contained
in the restart file which will be called
<a href="outputfiles.html#basename_1.rst">N_0??_yourcalc_1.rst</a>. Copy all of those files such that they drop
the "_1", <i>i.e.</i>, are called N_000_yourcalc.rst and so on.<br/>
<br/><big style="font-style: italic; text-decoration: underline;">Step 5 -
Run the simulation:</big><br/>
<br/>
The first thing we need to do is to instruct CAMPARI to use the restart files we created in the last step as input.<br/>
<br/>
<tt>
<a href="keywords.html#RESTART">FMCSC_RESTART</a> 1<br/>
<a href="keywords.html#RST_MC2MD">FMCSC_RST_MC2MD</a> 1<br/>
</tt>
<br/>
The second keyword above is a general instruction to use limited amounts of information from the restart file. 
We require some modification because we want to switch from an MC/MD hybrid calculation to an MD calculation (the alternative
would be to remove two lines exclusive to the hybrid setup from each restart file, <i>i.e.</i>, to fix the files by hand).
Next, we need to think about the extent of the simulation. Here, we will simulate in straight rigid-body/torsional dynamics 
for 4ns with 1ns of equilibration using a 2fs integration time step. Hence, <b>replace</b> the entries for the corresponding keywords
with the following:<br/>
<br/>
<tt>
<a href="keywords.html#NRSTEPS">FMCSC_NRSTEPS</a> 2210000<br/>
<a href="keywords.html#EQUIL">FMCSC_EQUIL</a> 710000<br/>
<a href="keywords.html#TIMESTEP">FMCSC_TIMESTEP</a> 0.002<br/>
<a href="keywords.html#TSTAT_TAU">FMCSC_TSTAT_TAU</a> 2.0<br/>
<a href="keywords.html#DYNAMICS">FMCSC_DYNAMICS</a> 2<br/>
</tt>
<br/>
You may wonder why the simulation uses 2.21x10<sup>6</sup> instead of 2x10<sup>6</sup> steps. The reason is that the
starting step will be read from the restart file which stopped at 2.1x10<sup>5</sup> at the end of the setup run.
So to add a full 4ns to that, the number of steps will have to be adjusted accordingly. We also adjust the coupling
time of the thermostat to a safe regime where suppression or alteration of fluctuations is quite unlikely
(see <a href="references.html#ref12_3">reference</a>).<br/>
The only thing missing are instructions to tell CAMPARI to produce the output required to be able to perform the
necessary analyses. Part of this can be done automatically. In fact, CAMPARI estimates relative free energies
between replicas via free energy perturbation as explained in the preface. Set:<br/>
<br/>
<tt>
<a href="keywords.html#REOLALL">FMCSC_REOLALL</a> 0<br/>
<a href="keywords.html#REOLINST">FMCSC_REOLINST</a> 5<br/>
<a href="keywords.html#REOLCALC">FMCSC_REOLCALC</a> 10<br/>
</tt>
<br/>
The above instructs CAMPARI to - every 10 integration steps - compute the energy for a structure evolved at a given condition
in all neighboring Hamiltonians (where neighbor relationships are purely established by the order in which replicas are
entered in the replica input file). It also instructs CAMPARI to print out instantaneous values for those
"foreign energy" calculations every 50 steps.<br/>
Lastly, we disable some analyses turned on by default to not clutter the output directory with unneeded files.<br/>
<br/>
<tt>
<a href="keywords.html#CONTACTCALC">FMCSC_CONTACTCALC</a> 200000000<br/>
<a href="keywords.html#POLCALC">FMCSC_POLCALC</a> 200000000<br/>
<a href="keywords.html#DIPCALC">FMCSC_DIPCALC</a> 200000000<br/>
<a href="keywords.html#DIFFRCALC">FMCSC_DIFFRCALC</a> 200000000<br/>
<a href="keywords.html#SAVCALC">FMCSC_SAVCALC</a> 200000000<br/>
<a href="keywords.html#COVCALC">FMCSC_COVCALC</a> 200000000<br/>
<a href="keywords.html#INTCALC">FMCSC_INTCALC</a> 200000000<br/>
<a href="keywords.html#TOROUT">FMCSC_TOROUT</a> 200000000<br/>
<a href="keywords.html#POLOUT">FMCSC_POLOUT</a> 200000000<br/>
<a href="keywords.html#ENSOUT">FMCSC_ENSOUT</a> 1000<br/>
<a href="keywords.html#ENOUT">FMCSC_ENOUT</a> 200000000<br/>
<a href="keywords.html#CHECKFREQ">FMCSC_CHECKFREQ</a> 100<br/>
</tt>
<br/>
You should now execute again:<br/>
<br/>
<tt>
mpirun -np 24 campari_mpi -k fes.key<br/>
</tt>
<br/>
This simulation will take a while to complete (you should check for the progress it made based on the output in 
<a href="outputfiles.html#ENSEMBLE.dat">N_000_ENSEMBLE.dat</a> and extrapolate from there).<br/>
<br/><big style="font-style: italic; text-decoration: underline;">Step 6 -
Compute corrections:</big><br/>
<br/>
Aside from systematic and stochastic errors introduced via insufficient sampling and/or a poor interpolation schedule,
additional errors may arise because FES calculations are acutely sensitive to system fluctuations and details
of the interaction model. This is why we use an integrator in conjunction with an appropriate thermostat here
(<a href="references.html#ref12_3">Bussi et al.</a>), which guarantees proper sampling of the
canonical ensemble. Corrections, however, are needed because of the truncation of the interaction model
(see section on cutoffs above). If we assume homogeneous solvent density and ignore the 12<sup>th</sup> repulsion
term, the 6<sup>th</sup> power dispersive interaction's truncation at 12.0&#8491; can be corrected for. This 
essentially corresponds to an infinite integral (with the proper volume element) for each solute atom with each
type of solvent atom (which for water is only the oxygen, as hydrogens maintain no steric or dispersive interactions).
For our system, this correction comes out to be -0.0619 kcal/mol.<br/>
The second type of correction was touched upon already as well. Given our choice for <a href="keywords.html#FEG_MODE">FMCSC_FEG_MODE</a>,
solute-solute interactions are integrated up along the interpolation schedule as well. They do not, however, form
a component of the physical transfer process described and therefore must be subtracted. For this purpose, do the 
following:<br/>
<ol type="a">
<li>Create a sub-directory within your working directory with the name SELFCORR.</li>
<li>Create a new sequence input file that just encodes a single methanol molecule (do not forget the "END").</li>
<li>Copy the working key-file for your final run into the new subdirectory and edit it such that it points to the new sequence file.</li>
<li>Further edit the key-file by removing the line with <a href="keywords.html#RESTART">FMCSC_RESTART</a>, and by setting
the total number of steps to 2x10<sup>6</sup> and the number of equilibration steps to 0.</li>
<li>In the new subdirectory, execute again "<tt>mpirun -np 24 campari_mpi -k fes.key</tt>".</li>
</ol>
This will perform an analogous simulation on a single methanol molecule in the gas-phase. After it is finished,
switch back to your original working directory.<br/>
<br/><big style="font-style: italic; text-decoration: underline;">Step 7 -
Analyze the results:</big><br/>
<br/>
As mentioned before, CAMPARI performs free energy perturbation calculations automatically. In detail:
In the language from above, both U<sub>i+1</sub> and U<sub>i-1</sub> are computed at condition i.
This is then used to obtain the thermodynamic averages:<br/>
<br/>
A(i&rarr;i+1) = -k<sub>b</sub>T&#183;ln(&lt;e<sup>&beta;&#183;(U<sub>i+1</sub>-U<sub>i</sub>)</sup>&gt;<sub>i</sub>)<br/>
A(i&rarr;i-1) = -k<sub>b</sub>T&#183;ln(&lt;e<sup>&beta;&#183;(U<sub>i-1</sub>-U<sub>i</sub>)</sup>&gt;<sub>i</sub>)<br/>
<br/>
At the end of the simulation, these values are written to files called - for example for the very first replica - 
<a href="outputfiles.html#N_XXX_OVERLAP.dat">N_000_OVERLAP.dat</a>. They immediately allow an estimation of the
total free energy of the process via both forward and backward FEP:<br/>
<br/>
<tt>
/bin/bash<br/>
export NREPS=24; export NREPSM2=`expr $NREPS - 2`; export NREPSM1=`expr $NREPS - 1`;<br/>
for i in `seq 0 $NREPSM2`; do (k=`printf "%03d" $i`; tail -n 1 N_${k}_OVERLAP.dat | awk '{print $3}' &gt;&gt; temporary_file.tmp) done<br/>
awk -v k=0 -v m=$NREPSM1 '{k = k + $1; if (NR == m) {print k;}}' temporary_file.tmp<br/>
for i in `seq 1 $NREPSM1`; do (k=`printf "%03d" $i`; head -n 1 N_${k}_OVERLAP.dat | awk '{print $3}' &gt;&gt; temporary_file2.tmp) done<br/>
awk -v k=0 -v m=$NREPSM1 '{k = k + $1; if (NR == m) {print k;}}' temporary_file2.tmp<br/>
exit<br/>
</tt>
<br/>
This assumes you run in a UNIX shell. Note that the sign for the reverse process will naturally be swapped.
Of course, you can also do this manually or any myriad number of alternative ways.
As mentioned above, the BAR method will yield more rapidly convergent and more accurate results of the FES. Therefore,
this tutorial provides a script for a free statistics package (R) that can compute the BAR estimates based on the generated
data. First copy the file <tt>"&lt;full path to CAMPARI directory&gt;/examples/tutorial7/tutorial7.R"</tt> to your working directory
and edit it according to your needs (if you followed this tutorial exactly and operate in a UNIX environment,
no changes should be necessary). In your working directory, start R, then:<br/>
<br/>
<tt>
doread &lt;- TRUE<br/>
source("tutorial7.R")<br/>
</tt>
<br/>
This will print the final numbers to the screen (R-terminal). In most cases you will find that the forward BAR estimate
lies between the FEP forward estimate and the negative of the FEP backward estimate.
There is a lot more information to be analyzed, however,
and we suggest - if you are interested in FES calculations per se - to extend the script (or write your own) to
compute hysteresis errors (differences in forward and backward FEP estimates), plot forward and reverse work
histograms (Crooks plots), and so on. Consult <a href="references.html#ref24_7">our 2010 JPCB publication</a>
and references therein. Note that the integrator we use in this tutorial is more accurate than the one in the publication,
and this means that the effective temperatures are slightly different.<br/>
<br/>

<br/>

</div>
                    
                </div>
                </div>
                </div>
                
            <!-- Side Navigation Bar -->
            <!--<div class="art-sidebar1">-->                                    
                <!-- Contributors Block -->
                <!--<div class="art-Block">
                    <div class="art-Block-tl"></div>
                    <div class="art-Block-tr"></div>
                    <div class="art-Block-bl"></div>
                    <div class="art-Block-br"></div>
                    <div class="art-Block-tc"></div>
                    <div class="art-Block-bc"></div>
                    <div class="art-Block-cl"></div>
                    <div class="art-Block-cr"></div>
                    <div class="art-Block-cc"></div>
                    <div class="art-Block-body">
                        <div class="art-BlockHeader">
                            <div class="l"></div>
                            <div class="r"></div>
                            <div class="art-header-tag-icon">
                                <div class="t">Contributors - Links</div>
                            </div>
                        </div><div class="art-BlockContent">
                            <div class="art-BlockContent-body">
                                <div>
                                <b>Pappu Lab</b><br />
                                Washington University in St. Louis, MO<br />
                                Website: <a href="lima.wustl.edu">lima.wustl.edu</a><br />
                                Phone: (999) 999-9999 <br/>
                                <br/>
                                <b>Andreas Vitalis</b><br />
                                Unistat de Zurich<br />
                                Website: <a href="papajohns.com">vitalis.net</a><br />
                                Phone: (111) 999-9999 <br/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>-->
                
                <!-- Search Block -->
                <!--
                <div class="art-Block">
                    <div class="art-Block-tl"></div>
                    <div class="art-Block-tr"></div>
                    <div class="art-Block-bl"></div>
                    <div class="art-Block-br"></div>
                    <div class="art-Block-tc"></div>
                    <div class="art-Block-bc"></div>
                    <div class="art-Block-cl"></div>
                    <div class="art-Block-cr"></div>
                    <div class="art-Block-cc"></div>
                    <div class="art-Block-body">
                        <div class="art-BlockHeader">
                            <div class="l"></div>
                            <div class="r"></div>
                            <div class="art-header-tag-icon">
                                <div class="t">Find Text</div>
                            </div>
                        </div><div class="art-BlockContent">
                            <div class="art-BlockContent-body">
                                <div><form method="get" id="newsletterform" action="javascript:void(0)">
                                <input type="text" value="" name="email" id="s" style="width: 95%;" />
                                <span class="art-button-wrapper">
                                    <span class="l"> </span>
                                    <span class="r"> </span>
                                    <input class="art-button" type="submit" name="search" value="Search"/>
                                </span>
                                </form></div>
                            </div>
                        </div>
                    </div>
                </div> 
                -->
                
                <!-- News/Updates Block -->
                <!--
                <div class="art-Block">
                    <div class="art-Block-tl"></div>
                    <div class="art-Block-tr"></div>
                    <div class="art-Block-bl"></div>
                    <div class="art-Block-br"></div>
                    <div class="art-Block-tc"></div>
                    <div class="art-Block-bc"></div>
                    <div class="art-Block-cl"></div>
                    <div class="art-Block-cr"></div>
                    <div class="art-Block-cc"></div>
                    <div class="art-Block-body">
                        <div class="art-BlockHeader">
                            <div class="l"></div>
                            <div class="r"></div>
                            <div class="art-header-tag-icon">
                                <div class="t">Recent News</div>
                            </div>
                        </div><div class="art-BlockContent">
                            <div class="art-BlockContent-body">
                                <div>
                                    <p><b>Jun 14, 2008</b><br/>
                                    Aliquam sit amet felis. Mauris semper, 
                                    velit semper laoreet dictum, quam 
                                    diam dictum urna, nec placerat elit 
                                    nisl in quam. Etiam augue pede, 
                                    molestie eget, rhoncus at, convallis 
                                    ut, eros. Aliquam pharetra.<br/>
                                    <a href="javascript:void(0)">Read more...</a></p>
                                                          
                                    <p><b>Aug 24, 2008</b><br/>
                                    Aliquam sit amet felis. Mauris semper, 
                                    velit semper laoreet dictum, quam 
                                    diam dictum urna, nec placerat elit 
                                    nisl in quam. Etiam augue pede, 
                                    molestie eget, rhoncus at, convallis 
                                    ut, eros. Aliquam pharetra.<br/>
                                    <a href="javascript:void(0)">Read more...</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> --><!-- End Sidebar -->

            </div>
        </div>
    </div> <!-- End main page contents -->

            
    <!-- Footer -->
    <div class="art-Footer">
    <div class="art-Footer-background">
    <div class="art-Footer-inner">
        <a href="#" class="art-rss-tag-icon" title="RSS"></a>
        <div class="art-Footer-text">
        <p><a href="#">Contact Us</a> | <a href="#">Terms of Use</a>
        | <a href="#">Lincense Information</a><br />
        Copyright &copy; 2010 . All Rights Reserved.</p>
        </div>
    </div>
    </div>
    </div>
    <p class="art-page-footer">XHTML and CSS valid. Powered by <a href="http://www.flashmint.com/">FlashMint</a> - flash templates provider.</p>
    <div style="text-align: center; font-size: 0.75em;">Design downloaded from <a href="http://www.freewebtemplates.com/">free website templates</a>.</div>
                
</div>
</body>
</html>
